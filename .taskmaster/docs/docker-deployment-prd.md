# Docker 기반 Vultr VPS 배포 계획

## 프로젝트 개요
ADK(Agent Development Kit) Stock Analysis 애플리케이션을 Docker를 사용하여 Vultr VPS에 배포

## 현재 문제점
- Vercel + Agent Engine 조합에서 SSE 이벤트 처리 실패
- 프로덕션 환경에서 에이전트 메시지가 표시되지 않음
- Agent Engine의 SSE 포맷 차이로 인한 호환성 문제

## 해결 방안
단일 Vultr VPS에 Docker를 사용하여 전체 애플리케이션 배포:
- Next.js 프론트엔드
- Python ADK 백엔드
- Nginx 리버스 프록시
- PostgreSQL 데이터베이스

## 요구사항

### 기능 요구사항
1. **컨테이너화**: 모든 컴포넌트를 Docker 컨테이너로 패키징
2. **오케스트레이션**: Docker Compose를 사용한 다중 컨테이너 관리
3. **네트워킹**: 컨테이너 간 안전한 통신
4. **환경 일관성**: 로컬 개발 환경과 동일한 프로덕션 환경
5. **모니터링**: 로그 수집 및 모니터링
6. **보안**: 기본적인 보안 설정 (HTTPS 제외)

### 비기능 요구사항
1. **성능**: 로컬 통신으로 인한 낮은 지연 시간
2. **신뢰성**: 프로세스 모니터링 및 자동 재시작
3. **유지보수성**: 간단한 배포 및 업데이트
4. **비용 효율성**: Vercel + Agent Engine 비용 절감

## 아키텍처 설계

### 컨테이너 구성
```
docker-compose.yml
├── adk-backend (Python/FastAPI)
├── adk-frontend (Next.js)
├── nginx (리버스 프록시)
└── postgres (데이터베이스)
```

### 네트워크 구성
- **frontend**: 포트 3000 (컨테이너 내부)
- **backend**: 포트 8000 (컨테이너 내부)
- **nginx**: 포트 80 (호스트 포트 80)
- **postgres**: 포트 5432 (컨테이너 내부)

### 데이터 흐름
1. 사용자 요청 → Nginx (포트 80)
2. 정적 파일 → Next.js 컨테이너
3. API 요청 → ADK 백엔드 컨테이너
4. 데이터베이스 접근 → PostgreSQL 컨테이너

## 구현 계획

### Phase 1: Docker 이미지 생성
1. **ADK 백엔드 이미지**
   - Python 3.11 기반
   - uv 패키지 매니저 사용
   - 의존성 설치 및 최적화

2. **Next.js 프론트엔드 이미지**
   - Node.js 20 기반
   - 빌드 최적화
   - 정적 파일 서빙

3. **Nginx 이미지**
   - 커스텀 설정 파일
   - SSL 준비 (주석 처리)

4. **PostgreSQL 이미지**
   - 기본 설정
   - 볼륨 마운트

### Phase 2: Docker Compose 구성
1. **서비스 정의**
   - 각 컨테이너의 설정
   - 환경 변수 관리
   - 볼륨 마운트

2. **네트워킹 설정**
   - 내부 네트워크 생성
   - 포트 매핑

3. **환경 설정**
   - 개발/프로덕션 환경 분리
   - 시크릿 관리

### Phase 3: 배포 및 테스트
1. **Vultr 서버 준비**
   - Ubuntu 22.04 설치
   - Docker 및 Docker Compose 설치

2. **배포 스크립트**
   - 자동화된 배포 프로세스
   - 롤백 기능

3. **모니터링 설정**
   - 로그 수집
   - 헬스 체크

### Phase 4: 최적화
1. **성능 최적화**
   - 이미지 크기 최적화
   - 캐싱 전략

2. **보안 강화**
   - 네트워크 격리
   - 최소 권한 원칙

## 성공 기준

### 기능 테스트
- [ ] Next.js 애플리케이션 정상 로딩
- [ ] ADK 백엔드 API 정상 응답
- [ ] SSE 스트리밍 정상 작동
- [ ] 데이터베이스 연결 및 CRUD 작업
- [ ] 에이전트 메시지 타임라인 표시

### 성능 테스트
- [ ] 페이지 로딩 시간 < 3초
- [ ] API 응답 시간 < 1초
- [ ] 메모리 사용량 < 1GB
- [ ] CPU 사용량 < 50%

### 안정성 테스트
- [ ] 컨테이너 자동 재시작
- [ ] 로그 정상 수집
- [ ] 백업 및 복구 기능

## 위험 요소 및 해결 방안

### 위험 1: Docker 이미지 크기
**해결**: Multi-stage 빌드 사용, 불필요한 파일 제거

### 위험 2: 메모리 부족
**해결**: Vultr 서버 사양 업그레이드 (2GB → 4GB)

### 위험 3: 네트워크 설정 복잡성
**해결**: Docker Compose 네트워킹 철저히 테스트

### 위험 4: 데이터 영속성
**해결**: PostgreSQL 볼륨 마운트 및 백업 설정

## 마일스톤

1. **Week 1**: Docker 이미지 생성 및 로컬 테스트
2. **Week 2**: Docker Compose 구성 및 통합 테스트
3. **Week 3**: Vultr 서버 배포 및 프로덕션 테스트
4. **Week 4**: 모니터링 및 최적화

## 결론

Docker 기반 배포를 통해 현재 Vercel + Agent Engine의 SSE 호환성 문제를 해결하고, 더 안정적이고 비용 효율적인 프로덕션 환경을 구축할 수 있습니다.